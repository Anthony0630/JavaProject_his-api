<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.his.api.db.dao.OrderDao">
    <select id="searchFrontStatistic" parameterType="int" resultType="HashMap">
        SELECT COUNT(*) AS count,
               SUM(amount) AS amount,
               SUM(number) AS number
        FROM tb_order
        WHERE customer_id = #{customerId}
          AND `status` IN (3, 5, 6)
    </select>

    <select id="searchIllegalCountInDay" parameterType="int" resultType="boolean">
        SELECT
            (
                ( SELECT COUNT(*)
                  FROM tb_order
                  WHERE customer_id = #{customerId}
                    AND create_date = CURRENT_DATE()
                    AND status &lt; 3
                ) >= 10
                    OR
                ( SELECT COUNT(*)
                  FROM tb_order
                  WHERE customer_id = #{customerId}
                    AND refund_date = CURRENT_DATE()
                    AND status = 4
                ) >= 5
                ) AS illegal
    </select>

    <update id="closeOrder">
        UPDATE tb_order
        SET status = 2
        WHERE status = 1
          AND TIMESTAMPDIFF(MINUTE, create_time, NOW()) > 30
    </update>

</mapper>
